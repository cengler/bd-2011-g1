\documentclass[a4paper, 10pt, notitlepage]{article}

\usepackage{moreverb} %para importar codigo

\usepackage{pepotina} %paquete personal para la caratula del DC

\usepackage[spanish,activeacute]{babel}
\usepackage{babel} %paquete de idioma

\usepackage[latin1]{inputenc}

\usepackage[normalem]{ulem}
\usepackage{ulem}

%\usepackage{color}

\usepackage{hyperref}
%\usepackage[all]{hypcap}

\usepackage{caeycaeBD}

\usepackage{fancyhdr} %linea sup con comentarios

\usepackage{lscape} %para hoja apaisada

\usepackage{framed} %para crear cajas de texto

\usepackage{lastpage} %ultima pagina

%\usepackage{pstricks}
%\usepackage{uml} %UML

\usepackage{listings}
%\lstset{
%  breaklines=true,                                     % line wrapping on
%  language=ocl,
%  frame=ltrb,
%  framesep=5pt,
%  basicstyle=\normalsize,
%  keywordstyle=\ttfamily\color{OliveGreen},
%  identifierstyle=\ttfamily\color{CadetBlue}\bfseries,
%  commentstyle=\color{Brown},
%  stringstyle=\ttfamily,
%  showstringspaces=ture
%}

\addtolength{\topmargin}{-50pt} 
\addtolength{\textwidth}{145pt}
\addtolength{\textheight}{120pt}
\addtolength{\oddsidemargin}{-70pt}

%\newcommand{\minix}{\textsl{minix }}

%%% Encabezado y pie de p'agina
\pagestyle{fancy}
\fancyhead[LO]{Base de Datos}
\fancyhead[C]{}
\fancyhead[RO]{P\'agina \thepage\ de \pageref{LastPage}}
\renewcommand{\headrulewidth}{0.4pt}
\fancyfoot{}

\newcommand{\FALTA}{{\bf FALTA FALTA FALTA FALTA FALTA FALTA FALTA FALTA }}
\def\var#1{\textsl{#1}}


\begin{document}

\universidad{Universidad de Buenos Aires}
\facultad{Facultad de ciencias exactas y naturales}
\departamento{Departamento de Computacion}
\materia{Base de Datos}
\resumen{Tp1}
\keys{MER, DER, MR, SQL, Base de Datos, Base de Datos Relacional}
\titulo{Tp1}
\subtitulo{Tp 1: Empresa de Transportes}
\grupo{Numero de grupo: 1}
\fecha{2do Cuatrimeste 2011}
\footspace{1cm}
\integrante{Piotrkowski, Kevin}{204/06}{marcoskevin@gmail.com}
\integrante{Rugnone, Martín}{665/04}{mrugnone@hotmail.com}
\integrante{Alvarez, María de los Angeles}{264/05}{mdelosaalvarez@hotmail.com}
\integrante{Engler, Christian}{314/05}{caeycae@gmail.com}

\maketitle{}

\tableofcontents

\newpage

\section{Introducción}
Este trabajo presenta la solucion al Trabajo Practico ``Bases de Datos, Segundo Cuatrimestre de 2011''\footnote{Enunciado del Trabajo Practico \textit{TP Primera Parte-2c2011.pdf}}. En este documento presentamos las hipotesis, decisiones de diseño, y diseño fisico de la solución propuesta.

La solucion se encuenta desarrollada con las siguientes metodologias y herramientas.

\begin{itemize}
\item Modelo de Entidad Relación y Modelo Relacional derivado.
\item Detalle de los supuestos asumidos para la resolución del problema. (Hipotesis)
\item Diseño físico correspondiente a la solución implementada. (En SQL Server 2005)
\item Restricciones adicionales al modelo
\item Código correspondiente a los stored procedures, triggers que se hayan implementado en la solución.
\end{itemize}

\section{Hipótesis}
\begin{enumerate}
	\item Una ruta es un camino posible para ir desde un punto a otro.
	\item Un recorrido no puede comenzar y finalizar en el mismo lugar.
	\item Con lo que respecta a las condiciones del año según el periodo, este último se tomó como las estaciones del año. Es decir: invierno, otoño, primavera y verano.
	\item No nos interesa discriminar el nombre del apellido de un chofer, pues no se cuenta con ningún requerimiento para realizar dicha separación(ej: alguna consulta para filtrar viajes por apellido del chofer).		
	\item Consideramos que \textbf{estado} del vehículo se refiere a una descripción general del mismo(ej:buen estado, averiado, abollado,...) en vez de referirse al discriminante que separa a los vehículos en: ``en uso'' y ``en reparación''.
\end{enumerate}

\section{MER}

\subsection{Decisiones de Diseño}

\begin{enumerate}
	\item Ruta es débil en relación a un recorrido porque sólo sirve como una forma de ir desde el origen del recorrido a su destino.
	\item Contingencia es una entidad débil porque puede haber una cantidad arbitraria de ellas por cada viaje realizado(en contraposición a una lista de contingencias predefinidas ej:choque, bloqueo de ruta, control policial, etc) y las mismas no tienen sentido sin su viaje relacionado.
	\item La ruta tiene asociado un clima por cada periodo del año. Como se menciono en las hipotesis el periodo son las estaciones del año.\\ Para ello contamos con tres entidades: ruta, clima y estación. Estas tres siempres están vinculadas juntas. Es decir, para cada (ruta,clima) existe una instancia de estación, por cada (clima, estación) se vincula a una ruta y por cada par (ruta, estacion) hay un clima asociado. Por tal motivo es que decidimos modelarlo como una ternaria.
	\item Con lo que respecta al chofer y la licencia, nos pareció más acorde separarlas en dos entidad pese a que en los requerimientos no queda clara dicha separación. Lo realizamos así para mayor claridad.
	\item Con respecto al diseño de la entidad \textbf{Dirección} primero se optó por hacerla débil de la ciudad.			
	
\begin{center}
\includegraphics[scale=0.50]{img/RecorridoDirDebil.png}
\end{center}

Al poner como clave primaria de \textbf{Direccion} su altura y nombre junto a la clave primaria de la ciudad, propagábamos estas tres claves como foráneas en otras entidad vinculadas.

Luego optamos por dejar \textbf{Dirección} como una entidad fuerte con una clave primaria \textbf{codDir} para así evitar la propagación de claves y obtener un diseño más sencillo.

\begin{center}
\includegraphics[scale=0.50]{img/RecorridoDirFuerte.png}
\end{center}

Vale aclarar que este diseño admite tuplas duplicados con el mismo codDir, altura, nombre y código de ciudad, sin embargo podemos impedir dicha situación agregando una restricción adicional al DER.
  
\item Decidimos no guardar la historia de las reparaciones. Hubieramos podido hacerla de esta manera.

\begin{center}
\includegraphics[scale=0.50]{img/ReparacionConHistoria.png}
\end{center}

En este diseño hubieramos necesitado agregar restricciones para asegurar que para toda fecha posterior a $Vehiculo.fechaAlta$ el $Vehiculo$ debe tener \textbf{solo y exactamente una} $Situacion$

Pero como no hay requerimientos explícitos por los cuales necesitemos guardar la historia, decidimos simplificar el diseño de la siguiente manera:

\begin{center}
\includegraphics[scale=0.50]{img/ReparacionSinHistoria.png}
\end{center}

\item Consideramos originalmente particionar los viajes en planificados y realizados, como se muestra en el siguiente diagrama:

\begin{center}
\includegraphics[scale=0.50]{img/viajePlanificado-Realizado.png}
\end{center}

Nos pareció mejor considerar los viajes realizados como una especialización de los planificados(todos los viajes son planificados y algunos de ellos además pueden ser realizados). Esto lo diseñamos como una relación de overlapping con una sola entidad llamada \textbf{Viaje Realizado}, describiendo que todos los viajes realizados heredan los mismos atributos que un viaje planificado, pero solo algunos viajes planificados tienen su correspondiente realizado.

\begin{center}
\includegraphics[scale=0.55]{img/viaje-Planificado-Realizado.png}
\end{center}

\item $(Chofer/Viaje Planificado)/Control$ es una agregación pues no toda relacion $Chofer/Viaje Planificado$ tiene controles asociados.
Además $Control$ es una Entidad asociada a la interrelacion entra $Vaje Planificado$ y $Control$ y no a una de ellas en particular.

\end{enumerate}

\subsection{DER}

\begin{center}
\includegraphics[height=0.95\textheight]{img/der.png}
\end{center}

\subsection{Restricciones}

\begin{enumerate}
	\item Dado 2 recorridos con distinto codigo, su origen y destino no pueden ser los mismos. Es decir, no puede haber dos recorridos con distinto codigo.
	\item Para todo recorrido, el origen no puede ser igual al destino
	\item El recorrido de la ruta de todo viaje realizado debe ser igual al recorrido del viaje planificado.
	\item Para todo recorrido que tiene un viaje planificado asociado, existe una ruta.
	\item Para todo viaje la cantidad de conductores debe ser entre 1 y 3 y la fechaHoraLlegadaEst debe ser mayor a fechaHoraPartida.
	\item Para todo viaje realizado la fechaHoraLlegada debe ser mayor a fechaHoraPartida.
	\item Para todo viaje planificado que no esta realizado el vehiculo utilizado debe estar en uso.	
	\item Para todo vehiculo en reparacion la fecha de ingreso es mayor a la fecha de alta.
	\item Para toda licencia, la fecha de obtencion es menor a la fecha de vencimiento
	\item Para todo chofer, la fecha de nacimiento es menor que la fecha de obtención de su licencia
	\item Para toda ruta, hay un único clima para todo período definido
	\item Para todo control, su fecha de realización debe ser anterior a la fecha de partida del viaje que se está controlando  
	\item La entidad Esación puede tomar los valores, \textit{verano}, \textit{invierno}, \textit{otoño} y \textit{primavera}
\end{enumerate}

\newpage

\section{MR}

\subsection{Esquema Relación}

\begin{mr}{Agencia de Viajes}

\entidad{Licencia}{\pk{nroLicencia}, fechaObtencion, fechaVencimiento, observaciones}
\entidadPK{nroLicencia}
\entidadCK{nroLicencia}

\entidad{Chofer}{\pk{nroDocumento}, fechaNac, nomApe, domicilio, telefono, \fk{nroLicencia}}
\entidadPK{nroDocumento}
\entidadCK{nroDocumento}
\entidadFK{nroLicencia}

\entidad{Conduce}{\pfk{nroDocumento}, \pfk{codViaje}}
\entidadPK{(nroDocumento, codViaje)}
\entidadCK{(nroDocumento, codViaje)}
\entidadFK{nroDocumento, codViaje}

\entidad{Control}{\pk{codControl}, \fk{nroDocumento}, \fk{codViaje}, \fk{codTipo}, resultadoTest, fechaControl}
\entidadPK{codControl}
\entidadCK{codControl}
\entidadFK{(nroDocumento, codViaje), codTipo}

\entidad{TipoTest}{\pk{codTipo}, descripcion}
\entidadPK{codTipo}
\entidadCK{codTipo}

\entidad{Contingencia}{\pk{nroContingencia}, \pfk{codViaje}, descripcion}
\entidadPK{(nroContingencia, codViaje)}
\entidadCK{(nroContingencia, codViaje)}
\entidadFK{codViaje}

\entidad{Direccion}{\pk{codDir}, calle, altura, \fk{codCiudad}}
\entidadPK{codDir}
\entidadCK{codDir}
\entidadFK{codCiudad}

\entidad{Ciudad}{\pk{codCiudad}, nombre}
\entidadPK{codCiudad}
\entidadCK{codCiudad}

\entidad{Recorrido}{\pk{codRecorrido}, nombre, \fk{codDirOrigien}, \fk{codDirDestino}}
\entidadPK{codRecorrido}
\entidadCK{codRecorrido}
\entidadFK{codDirOrigien, codDirDestino}

\entidad{Ruta}{\pk{numRuta}, \pfk{codRecorrido}, cantKm, condicionesCamino, cantPeajes, tiempoEstimado}
\entidadPK{(numRuta, codRecorrido)}
\entidadCK{(numRuta, codRecorrido)}
\entidadFK{codRecorrido}

\entidad{Estado}{\pk{codEstado}, descripcion}
\entidadPK{codEstado}
\entidadCK{codEstado}

\entidad{Vehiculo}{\pk{nroPatente}, modelo, marca, capacidad, fechaAlta, \fk{codEstado}, enUso}
\entidadPK{nroPatente}
\entidadCK{nroPatente}
\entidadFK{codEstado}

\entidad{VehiculoEnReparacion}{\pfk{nroPatente}, fechaIngresoReparacion}
\entidadPK{nroPatente}
\entidadCK{nroPatente}
\entidadFK{nroPatente}

\entidad{ViajePlanificado}{\pk{codViaje}, fechaHoraPartida, fechaHoraLlegadaEst, \fk{nroPatente}, \fk{codRecorrido}, realizado}
\entidadPK{codViaje}
\entidadCK{codViaje}
\entidadFK{nroPatente,codRecorrido}

\entidad{ViajeRealizado}{\pk{codViaje}, fechaHoraLlegada, \fk{numRuta}, \fk{codRutaRecorrido}}
\entidadPK{codViaje}
\entidadCK{codViaje}
\entidadFK{codViaje, (numRuta, codRutaRecorrido)}

\entidad{Participa}{\pfk{codRecorrido}, \pfk{codRuta}, \pfk{nombreEstacion}, \fk{codClima}}
\entidadPK{((codRecorrido, codRuta), nombreEstacion)}
\entidadCK{((codRecorrido, codRuta), nombreEstacion)}
\entidadFK{(codRecorrido, codRuta), nombreEstacion, codClima}

\entidad{Estacion}{\pk{nombreEstacion}}
\entidadPK{nombreEstacion}
\entidadCK{nombreEstacion}

\entidad{Clima}{\pk{codClima}, descripcion}
\entidadPK{codClima}
\entidadCK{codClima}

\end{mr}

\subsection{Restricciones}

\paragraph{Nota: a menos que explícitamente se mencione que un valor debe estar en otra entidad y viceversa, no vale la vuelta}

\begin{enumerate}
	\item $Chofer.nroLicencia$ debe estar en $Licencia.nroLicencia$
	\item $Conduce.codViaje$ debe estar en $ViajePlanificado.codViaje$ y viceversa
	\item $Conduce.nroDocumento$ debe estar en $Chofer.nroDocumento$
	\item $Control.nroDoumento$ debe estar en $Chofer.nroDocumento$
	\item $Control.codViaje$ debe estar en $ViajePlanificado.codViaje$
	\item $Control.codTipo$ debe estar en $TipoTest.codTipo$
	\item $Contingencia.codViaje$ debe estar en $ViajeRealizado.codViaje$
	\item $Direccion.codCiudad$ debe estar en $Ciudad.codCiudad$
	\item $Recorrido.codDirOrigen$ debe estar en $Direccion.codDir$
	\item $Recorrfio.codDirDestino$ debe estar en $Direccion.codDir$
	
	
	\item $Ruta.codRecorrido$ debe estar en $Recorrido.codRecorrido$
	\item $Vehiculo.fechaReparacion$ debe ser NULL si y solo si $Vehiculo.enUso$ es cierto
	\item $Vehiculo.codEstado$ debe estar en $Estado.codEstado$
	\item $Viaje.nroPatente$ debe estar en $Vehiculo.nroPatente$
	\item $Viaje.codRecorrido$ debe estar en $Recorrido.codRecorrido$
	\item $ViajeRealizado.codRuta$ debe estar en $Ruta.codRuta$
	\item $ViajeRealizado.codRutaRecorrido$ debe estar en $Recorrido.codRecorrido$
	\item $Participa.codRecorrido$ debe estar en $Recorrido.codRecorrido$
	\item $Participa.nombreEstacion$ debe estar en $Estacion.nombreEstacion$
	\item $Participa.codClima$ debe estar en $Clima.codClima$
	\item $Licencia.fechaObtencion$ es anterior a $Licencia.fechaVencimiento$
	\item $Contingencia.codViaje$ debe estar en $Viaje.codViaje$
	\item Si $Vehiculo.enUso$ es false, entonces debe existir $VehiculoEnReparacion$
	\item Si $Viaje.realizado$ es true, entonces debe existir $ViajeRealizado$ 
	\item Si $Vehiculo.enUso$ toma valores booleanos
	\item $Viaje.realizado$ toma valores booleanos
	
	\item $\forall Recorrido1 (\not\exists Recorrido2 (Recorrido1.codRecorrido \neq Recorrido2.codRecorrido$  $\wedge$ \\
	$Recorrido2.codDirDestino \neq Recorrido1.codDirDestino$ $\wedge$   \\
	$Recorrido2.codDirOrigen \neq Recorrido1.codDirOrigen))$
	\item $recorrido.CodDirOrigen \neq Recorrido.codDirDestino$
	\item $ViajeRealizado.recorrio.tuvo =  ViejaRealizado.tiene$ 
	\item $\forall rec1 \in recorrido ( rec1.tiene \neq NULL \Rightarrow \exists r1 \in ruta (Recorrido.ruta = r1))$
	\item $\forall v \in ViajePlanificado ( 1 \leq cantidad(v.conduce) \leq 3 \wedge v.fechaHoraLlegadaEst > v.fechaHoraPartida )$ 
	\item $\forall vr \in ViajeRealizado ( \exists vp \in ViajePlanificado (vr.codViaje = vp.codViaje \wedge vr.fechaHoraLlegada > vp.fechaHoraPartida))$
	\item $\forall vp \in ViajePlanificado ( vp.realiza.vehiculoEnUso = true  \wedge (\not\exists vr \in ViajeRealizado ( vp.codViaje = vr.codViaje)))$  
	\item $\forall veh \in Vehiculo (veh.enUso = FALSE \Rightarrow veh.fechaIngresoReparacion > veh.fechaAlta)$
	\item $\forall lic \in Licencia (lic.fechaObtencion < lic.fechaVencimiento)$
	\item Para todo chofer, la fecha de nacimiento es menor que la fecha de obtención de su licencia
	\item Para toda ruta, hay un único clima para todo período definido
	\item Para todo control, su fecha de realización debe ser anterior a la fecha de partida del viaje que se está controlando
\end{enumerate}

\newpage

\input{disenioFisico.tex}

\end{document}




